{
  "url": "https://docs.memfiredb.com/docs/app/development_guide/auth/auth-deep-dive/auth-policies/",
  "title": "第三部分:策略 | MemFire Cloud在线文档",
  "depth": 1,
  "timestamp": "2025-08-12 17:49:07",
  "html": "<main class=\"page-content bg-transparent\">\n<div class=\"top-header d-print-none\" id=\"top-header\">\n<div class=\"header-bar d-flex justify-content-between\">\n<div class=\"d-flex align-items-center\">\n<a alt=\"HomePage\" aria-label=\"HomePage\" class=\"logo-icon me-3\" href=\"/\">\n<div class=\"small\">\n<!--?xml version=\"1.0\" encoding=\"UTF-8\"?-->\n<svg height=\"112px\" version=\"1.1\" viewbox=\"0 0 99 112\" width=\"99px\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n<title>MemFireDB备份 6</title>\n<defs>\n<lineargradient id=\"linearGradient-1\" x1=\"49.9999885%\" x2=\"49.9999885%\" y1=\"98.082503%\" y2=\"0.766550128%\">\n<stop offset=\"0%\" stop-color=\"#ED1C23\"></stop>\n<stop offset=\"100%\" stop-color=\"#FBAF3B\"></stop>\n</lineargradient>\n</defs>\n<g fill=\"none\" fill-rule=\"evenodd\" id=\"定稿\" stroke=\"none\" stroke-width=\"1\">\n<g id=\"MemFireDB备份-6\">\n<polygon fill=\"#F9AE7C\" id=\"Fill-1\" points=\"25.9728553 40.7912363 47.4268317 0.00591833831 1.15453123 26.7215251\"></polygon>\n<polygon fill=\"#F9AE7C\" id=\"Fill-3\" points=\"97.4213117 26.7267606 51.1285247 0.000910513587 72.4242993 40.8351686\"></polygon>\n<polygon fill=\"#F9904A\" id=\"Fill-5\" points=\"24.8347133 42.7618153 0.000455256793 28.682999 0.000455256793 82.1608764\"></polygon>\n<polygon fill=\"url(#linearGradient-1)\" id=\"Fill-7\" points=\"27.6634514 42.4662399 49.279044 109.05096 70.7296059 42.507213 49.2779058 1.3747617\"></polygon>\n<polygon fill=\"#F9904A\" id=\"Fill-9\" points=\"98.5660549 28.6951771 73.5622137 42.8047233 98.5660549 82.1719163\"></polygon>\n<polygon fill=\"#FB6D33\" id=\"Fill-13\" points=\"72.2987623 45.061545 50.7514582 111.900071 97.579172 84.8646465\"></polygon>\n<polygon fill=\"#FB6D33\" id=\"Fill-15\" points=\"26.1006687 45.0226206 0.987565799 84.8644188 47.8095888 111.898705\"></polygon>\n<path d=\"M60.0737516,38.507213 C59.3168872,35.669825 57.0462939,33.3514298 57.0462939,33.3514298 C57.0462939,33.3514298 57.0804382,35.8849338 56.2894295,37.513615 C55.4847631,39.1696116 53.8765685,40.3054773 53.8765685,40.3054773 C53.8765685,40.3054773 56.1016361,33.8840802 54.2715038,30.1247973 C52.0259496,25.5073552 49.1771803,23.3357803 49.1771803,23.3357803 C49.1771803,23.3357803 50.1070423,28.1319107 48.6240432,31.5065016 C47.1672215,34.8264618 42.8058614,36.7260208 40.7241997,38.7132167 C39.1865699,40.1791435 38.0814341,43.0711623 37.6068289,44.4847347 C37.5715465,44.5883056 37.560165,44.6918765 37.5533362,44.7943093 C37.584066,43.9816759 37.8890881,39.8024186 40.9654858,37.4293925 C43.8404325,35.2111538 41.2431925,30.3478731 41.2431925,30.3478731 C41.2431925,30.3478731 41.7212121,32.5638355 40.9939394,34.1401622 C40.2655285,35.7153507 38.7187936,36.5962726 38.0154218,38.259098 C37.3883056,39.7409589 37.5203301,44.1432921 37.5453692,44.8409731 C37.5453692,44.8591834 37.5476455,44.8762555 37.5476455,44.8921895 C37.5476455,44.9263338 37.5487836,44.9456822 37.5487836,44.9456822 L37.5487836,44.9115379 C37.5590269,45.2655001 37.7138142,45.6080808 37.9972116,45.8448143 L48.3713757,55.6442168 C48.8380139,56.0323232 49.5163466,56.0334614 49.9841229,55.6476312 L60.5938825,45.7105136 C60.9034571,45.4544316 61.0719021,45.0686015 61.0457249,44.6656992 C60.9546735,43.2282259 60.5699815,40.3692133 60.0737516,38.507213\" fill=\"#FFFFFF\" id=\"Fill-17\"></path>\n</g>\n</g>\n</svg>\n</div>\n<div class=\"big\">\n<svg height=\"20\" width=\"232\" xmlns=\"http://www.w3.org/2000/svg\"><defs><lineargradient id=\"a\" x1=\"50%\" x2=\"50%\" y1=\"98.083%\" y2=\".767%\"><stop offset=\"0%\" stop-color=\"#ED1C23\"></stop><stop offset=\"100%\" stop-color=\"#FBAF3B\"></stop></lineargradient></defs><g fill=\"none\" fill-rule=\"evenodd\"><path d=\"M78.622 12.384l1.596 21.94H77.49l-.847-14.154-8.98 15.523-4.899-15.53-4.416 14.162H55.6l7.085-21.871 5.712 17.174 10.224-17.244zm99.46.382l.324.01.454.036c.085.008.175.018.269.03l.61.096c1.09.203 2.518.644 3.883 1.596l.515.383-.46 3.694-.413-.62-.154-.195-.255-.285c-.765-.802-2.485-2.188-5.23-2.188-4.55 0-8.723 3.809-9.3 8.491-.287 2.311.334 4.469 1.755 6.077 1.342 1.517 3.257 2.354 5.39 2.354 2.606 0 4.58-1.225 5.606-2.04l.359-.3.424-.408.507-.552-.466 3.766-.093.06a12.622 12.622 0 01-4.577 1.842l-.629.1-.53.058-.418.027-.444.003c-2.918-.002-5.532-1.142-7.36-3.21-1.851-2.096-2.67-4.88-2.305-7.837.73-5.88 5.964-10.696 11.806-10.974l.732-.014zm18.174 9.018c1.724 0 3.344.713 4.443 1.956 1.101 1.248 1.59 2.88 1.377 4.596-.432 3.504-3.808 6.466-7.375 6.466-1.728 0-3.348-.715-4.45-1.96-1.096-1.242-1.583-2.864-1.377-4.563.44-3.52 3.818-6.495 7.382-6.495zm19.446.535l-1.486 12.02h-2.558l.16-1.292c-.936.93-2.462 1.755-4.173 1.755-1.318 0-2.48-.492-3.267-1.385-.804-.91-1.168-2.184-1.008-3.497l.9-7.274 2.597-.327-.914 7.402c-.101.785.084 1.466.525 1.968.49.552 1.27.845 2.25.845 1.526 0 3.3-1.155 3.51-2.873l.87-7.015 2.594-.327zm-63.587-.547c1.77 0 3.21.58 4.164 1.678 1.047 1.207 1.48 3.01 1.263 5.233l-.097.771h-9.914c.16 1.896 1.567 2.979 3.895 2.979 1.806 0 2.878-.434 3.868-.961l1.119-.623-.312 2.522-.106.06c-1.224.687-2.604 1.356-4.8 1.356-2.092 0-3.873-.708-5.006-1.992-.991-1.12-1.404-2.599-1.198-4.272.548-4.433 4.001-6.751 7.124-6.751zm-62.717 0c1.771 0 3.211.58 4.164 1.678 1.048 1.207 1.48 3.01 1.263 5.233l-.097.771h-9.914c.16 1.896 1.567 2.979 3.895 2.979 1.622 0 2.652-.35 3.563-.803l.594-.315.83-.466-.312 2.522-.105.06c-1.224.687-2.604 1.356-4.8 1.356-2.093 0-3.874-.708-5.007-1.992-.99-1.12-1.404-2.599-1.197-4.272.547-4.433 4-6.751 7.123-6.751zM231.476 12l-2.767 22.34h-2.556l.197-1.59c-1.104 1.191-2.882 2.021-4.471 2.021-1.781 0-3.24-.583-4.217-1.69-1.02-1.151-1.452-2.817-1.222-4.686.485-3.908 3.43-6.636 7.167-6.636 1.565 0 3.065.832 3.852 2.064l1.356-10.968 2.661-.855zm-42.07.002L186.64 34.34h-2.556l2.664-21.483 2.66-.854zm-56.632 1.268l-1.166 2.527h-9.586l-.85 6.867h6.627v.48h-.12l-.883 1.778v.24h-5.933l-1.138 9.163h-2.729l2.612-21.055h13.166zm2.715 9.038l-1.497 12.017h-2.559l1.455-11.722 2.601-.295zm-24.427-.537c1 0 1.93.427 2.616 1.204.84.95 1.224 2.29 1.053 3.677l-.955 7.673h-2.527l.922-7.445c.13-1.017-.027-1.81-.45-2.287-.326-.367-.815-.554-1.458-.554-1.954 0-3.178 1.346-3.332 2.613l-.955 7.673h-2.556l.922-7.445c.127-1.03-.024-1.826-.442-2.297-.319-.362-.801-.544-1.437-.544-1.522 0-3.3 1.166-3.516 2.901l-.912 7.385h-2.559l1.455-11.722 2.594-.295-.146 1.164c1.027-1.077 2.419-1.701 3.854-1.701 1.375 0 2.58.79 3.226 2.083.914-1.13 2.05-2.083 4.603-2.083zm29.487.532l-.206 1.73c1.082-.978 2.932-1.7 4.514-1.7h.269l-.271 2.282h-.214c-1.814 0-4.469.837-4.7 2.7l-.866 7.01h-2.558l1.45-11.693 2.582-.329zm55.47 1.865c-2.31 0-4.27 1.792-4.563 4.168-.144 1.145.15 2.196.824 2.957.64.725 1.586 1.126 2.656 1.126 2.292 0 4.241-1.78 4.532-4.14.146-1.169-.144-2.237-.821-3.003-.634-.715-1.567-1.108-2.628-1.108zm27.497-.029c-2.278 0-4.15 1.752-4.45 4.17-.149 1.187.137 2.255.8 3.006.611.692 1.526 1.076 2.57 1.076 2.294 0 4.173-1.743 4.468-4.143.152-1.21-.13-2.285-.79-3.033-.623-.704-1.52-1.076-2.598-1.076zm-134.356.045c-1.89 0-3.372 1.094-4.015 2.947h7.164a2.853 2.853 0 00-.71-1.956c-.574-.648-1.416-.991-2.439-.991zm62.715 0c-1.892 0-3.37 1.094-4.013 2.947h7.166a2.867 2.867 0 00-.713-1.956c-.573-.648-1.416-.991-2.44-.991zm-17.267-7.614c.919 0 1.706.748 1.754 1.668a1.587 1.587 0 01-1.603 1.692c-.917 0-1.704-.75-1.754-1.668a1.593 1.593 0 011.603-1.692z\" fill=\"#116\"></path><path d=\"M11.131 17.482L20.326.002.495 11.453zm30.621-6.028L21.912 0l9.127 17.5z\" fill=\"#F9AE7C\"></path><path d=\"M10.643 18.326L0 12.293v22.919z\" fill=\"#F9904A\"></path><path d=\"M11.856 18.2l9.264 28.536 9.193-28.519L21.119.59z\" fill=\"url(#a)\"></path><path d=\"M42.243 12.298l-10.716 6.047 10.716 16.872z\" fill=\"#F9904A\"></path><path d=\"M30.985 19.312l-9.234 28.645L41.82 36.371zm-19.799-.017L.423 36.37 20.49 47.957z\" fill=\"#FB6D33\"></path><path d=\"M25.746 16.503c-.324-1.216-1.298-2.21-1.298-2.21s.015 1.086-.324 1.784c-.345.71-1.034 1.197-1.034 1.197s.954-2.752.17-4.363c-.963-1.98-2.184-2.91-2.184-2.91s.398 2.056-.237 3.502c-.624 1.423-2.494 2.237-3.386 3.088-.659.629-1.132 1.868-1.336 2.474a.509.509 0 00-.023.133c.013-.349.144-2.14 1.463-3.157 1.232-.95.119-3.035.119-3.035s.205.95-.107 1.625c-.312.676-.975 1.053-1.277 1.766-.268.635-.212 2.522-.201 2.82v.023l.001.022v-.014a.54.54 0 00.193.4l4.446 4.2c.2.166.49.166.69.001l4.548-4.259a.535.535 0 00.193-.448c-.039-.616-.203-1.84-.416-2.639\" fill=\"#FFF\"></path></g></svg>\n</div>\n</a>\n<button class=\"btn btn-icon btn-soft\" id=\"close-sidebar\">\n<span class=\"material-icons size-20 menu-icon align-middle\">menu</span>\n</button>\n</div>\n<div class=\"d-flex align-items-center\">\n<ul class=\"list-unstyled mb-0\">\n</ul>\n<a class=\"btn btn-icon btn-default ms-4\" href=\"https://memfiredb.com/\" target=\"_blank\" type=\"button\">官网</a>\n<a class=\"btn btn-icon btn-default ms-4\" href=\"https://community.memfiredb.com/\" target=\"_blank\" type=\"button\">论坛</a>\n<a class=\"btn btn-icon btn-default ms-4\" href=\"https://cloud.memfiredb.com/auth/login\" target=\"_blank\" type=\"button\">登录</a>\n<button aria-label=\"Toggle user interface mode\" class=\"btn btn-icon btn-default ms-2\" id=\"mode\" type=\"button\">\n<span class=\"toggle-dark\">\n<svg fill=\"currentColor\" height=\"30\" viewbox=\"0 0 48 48\" width=\"30\" xmlns=\"http://www.w3.org/2000/svg\">\n<title>Enable dark mode</title>\n<path d=\"M24 42q-7.5 0-12.75-5.25T6 24q0-7.5 5.25-12.75T24 6q.4 0 .85.025.45.025 1.15.075-1.8 1.6-2.8 3.95-1 2.35-1 4.95 0 4.5 3.15 7.65Q28.5 25.8 33 25.8q2.6 0 4.95-.925T41.9 22.3q.05.6.075.975Q42 23.65 42 24q0 7.5-5.25 12.75T24 42Zm0-3q5.45 0 9.5-3.375t5.05-7.925q-1.25.55-2.675.825Q34.45 28.8 33 28.8q-5.75 0-9.775-4.025T19.2 15q0-1.2.25-2.575.25-1.375.9-3.125-4.9 1.35-8.125 5.475Q9 18.9 9 24q0 6.25 4.375 10.625T24 39Zm-.2-14.85Z\"></path>\n</svg>\n</span>\n<span class=\"toggle-light\">\n<svg fill=\"currentColor\" height=\"30\" viewbox=\"0 0 48 48\" width=\"30\" xmlns=\"http://www.w3.org/2000/svg\">\n<title>Enable light mode</title>\n<path d=\"M24 31q2.9 0 4.95-2.05Q31 26.9 31 24q0-2.9-2.05-4.95Q26.9 17 24 17q-2.9 0-4.95 2.05Q17 21.1 17 24q0 2.9 2.05 4.95Q21.1 31 24 31Zm0 3q-4.15 0-7.075-2.925T14 24q0-4.15 2.925-7.075T24 14q4.15 0 7.075 2.925T34 24q0 4.15-2.925 7.075T24 34ZM3.5 25.5q-.65 0-1.075-.425Q2 24.65 2 24q0-.65.425-1.075Q2.85 22.5 3.5 22.5h5q.65 0 1.075.425Q10 23.35 10 24q0 .65-.425 1.075-.425.425-1.075.425Zm36 0q-.65 0-1.075-.425Q38 24.65 38 24q0-.65.425-1.075.425-.425 1.075-.425h5q.65 0 1.075.425Q46 23.35 46 24q0 .65-.425 1.075-.425.425-1.075.425ZM24 10q-.65 0-1.075-.425Q22.5 9.15 22.5 8.5v-5q0-.65.425-1.075Q23.35 2 24 2q.65 0 1.075.425.425.425.425 1.075v5q0 .65-.425 1.075Q24.65 10 24 10Zm0 36q-.65 0-1.075-.425-.425-.425-.425-1.075v-5q0-.65.425-1.075Q23.35 38 24 38q.65 0 1.075.425.425.425.425 1.075v5q0 .65-.425 1.075Q24.65 46 24 46ZM12 14.1l-2.85-2.8q-.45-.45-.425-1.075.025-.625.425-1.075.45-.45 1.075-.45t1.075.45L14.1 12q.4.45.4 1.05 0 .6-.4 1-.4.45-1.025.45-.625 0-1.075-.4Zm24.7 24.75L33.9 36q-.4-.45-.4-1.075t.45-1.025q.4-.45 1-.45t1.05.45l2.85 2.8q.45.45.425 1.075-.025.625-.425 1.075-.45.45-1.075.45t-1.075-.45ZM33.9 14.1q-.45-.45-.45-1.05 0-.6.45-1.05l2.8-2.85q.45-.45 1.075-.425.625.025 1.075.425.45.45.45 1.075t-.45 1.075L36 14.1q-.4.4-1.025.4-.625 0-1.075-.4ZM9.15 38.85q-.45-.45-.45-1.075t.45-1.075L12 33.9q.45-.45 1.05-.45.6 0 1.05.45.45.45.45 1.05 0 .6-.45 1.05l-2.8 2.85q-.45.45-1.075.425-.625-.025-1.075-.425ZM24 24Z\"></path>\n</svg>\n</span>\n</button>\n</div>\n</div>\n</div>\n<div class=\"container-fluid\">\n<div class=\"layout-spacing\">\n<div class=\"d-md-flex justify-content-between align-items-center\"></div>\n<div class=\"row flex-xl-nowrap\">\n<div class=\"docs-toc col-xl-3 d-xl-block\"><toc>\n<div class=\"fw-bold text-uppercase mb-2\">本页</div>\n\n</toc></div>\n<div class=\"docs-toc-mobile d-print-none d-xl-none\">\n<button aria-expanded=\"false\" class=\"btn-secondary dropdown-toggle\" data-bs-offset=\"0,0\" data-bs-toggle=\"dropdown\" id=\"toc-dropdown-btn\" type=\"button\">关于</button>\n</div>\n<div class=\"docs-content col-12 col-xl-9 mt-0\">\n<div class=\"mb-0 d-flex\">\n<h1 class=\"content-title mb-0\">\n                                                    第三部分:策略\n                                                    \n                                                </h1>\n</div>\n<div class=\"main-content\" data-bs-root-margin=\"0px 0px -65%\" data-bs-spy=\"scroll\" data-bs-target=\"#toc-mobile\" id=\"content\">\n<div data-prismjs-copy=\"\" data-prismjs-copy-error=\"\" data-prismjs-copy-success=\"\">\n<h3 id=\"关于\">关于 <a aria-hidden=\"true\" class=\"anchor\" href=\"#%e5%85%b3%e4%ba%8e\"><i class=\"material-icons align-middle\">link</i></a></h3><p>如何将表的访问限制在认证用户、行级策略和基于电子邮件域的访问。</p>\n<h3 id=\"观察\">观察 <a aria-hidden=\"true\" class=\"anchor\" href=\"#%e8%a7%82%e5%af%9f\"><i class=\"material-icons align-middle\">link</i></a></h3><div classname=\"video-container\">\n<iframe allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen=\"\" frameborder=\"1\" src=\"https://www.youtube-nocookie.com/embed/0LvCOlELs5U\"></iframe>\n</div>\n<h3 id=\"基于用户的行级策略\">基于用户的行级策略 <a aria-hidden=\"true\" class=\"anchor\" href=\"#%e5%9f%ba%e4%ba%8e%e7%94%a8%e6%88%b7%e7%9a%84%e8%a1%8c%e7%ba%a7%e7%ad%96%e7%95%a5\"><i class=\"material-icons align-middle\">link</i></a></h3><p>现在我们知道了如何根据JWT角色来限制对表的访问，我们可以把它和用户管理结合起来，让我们更多地控制你的用户可以从你的数据库中读取和写入哪些数据。</p>\n<p>我们将从用户会话在Supabase中的工作方式开始，然后转到编写以用户为中心的策略。</p>\n<p>比方说，我们要把一个用户第一次注册到我们的服务中。典型的方法是在supabase-js中调用以下方法：</p>\n<div class=\"prism-codeblock\">\n<div class=\"code-toolbar\"><pre class=\"language-jsx\" id=\"e630a6c\" tabindex=\"0\"><code class=\"language-jsx\"><span class=\"token comment\">// see full api reference here: /docs/app/sdkdocs/javascript/auth-signup</span>\nsupabase<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">.</span><span class=\"token function\">signUp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> email<span class=\"token punctuation\">,</span> password <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre><div class=\"toolbar\"><div class=\"toolbar-item\"><button aria-label=\"copy\" class=\"copy-to-clipboard-button\" data-copy-state=\"copy\" type=\"button\"><span></span></button></div></div></div>\n</div>\n<p>默认情况下，这将向用户发送一封确认电子邮件。当用户点击电子邮件中的链接时，他们将被重定向到你的网站（你需要在仪表板上的授权&gt;设置中提供你的网站网址。默认情况下，这是http://localhost:3000），包括查询参数的完整URL将看起来像这样:</p>\n<div class=\"prism-codeblock\">\n<div class=\"code-toolbar\"><pre class=\"language- language-none\" id=\"006c6eb\" tabindex=\"0\"><code class=\"language-none\">http://localhost:3000/#access_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJhdXRoZW50aWNhdGVkIiwiZXhwIjoxNjE2NDI5MDY0LCJzdWIiOiI1YTQzNjVlNy03YzdkLTRlYWYtYThlZS05ZWM5NDMyOTE3Y2EiLCJlbWFpbCI6ImFudEBzdXBhYmFzZS5pbyIsImFwcF9tZXRhZGF0YSI6eyJwcm92aWRlciI6ImVtYWlsIn0sInVzZXJfbWV0YWRhdGEiOnt9LCJyb2xlIjoiYXV0aGVudGljYXRlZCJ9.4IFzn4eymqUNYYo2AHLxNRL8m08G93Qcg3_fblGqDjo&amp;expires_in=3600&amp;refresh_token=RuioJv2eLV05lgH5AlJwTw&amp;token_type=bearer&amp;type=signup</code></pre><div class=\"toolbar\"><div class=\"toolbar-item\"><button aria-label=\"copy\" class=\"copy-to-clipboard-button\" data-copy-state=\"copy\" type=\"button\"><span></span></button></div></div></div>\n</div>\n<p>让我们把这个问题拆开，以便更容易阅读。</p>\n<div class=\"prism-codeblock\">\n<div class=\"code-toolbar\"><pre class=\"language-jsx\" id=\"340215d\" tabindex=\"0\"><code class=\"language-jsx\"><span class=\"token comment\">// 基本网址 - 你在app.supabase.com仪表板的授权设置中设置的任何网址</span>\n<span class=\"token literal-property property\">http</span><span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">localhost:3000</span><span class=\"token regex-delimiter\">/</span></span>\n\n<span class=\"token comment\">// 注意我们使用'#'（片段）而不是'?'查询参数</span>\n<span class=\"token comment\">// 访问令牌是发给用户的JWT。</span>\n#access_token<span class=\"token operator\">=</span>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9<span class=\"token punctuation\">.</span>eyJhdWQiOiJhdXRoZW50aWNhdGVkIiwiZXhwIjoxNjE2NDI5MDY0LCJzdWIiOiI1YTQzNjVlNy03YzdkLTRlYWYtYThlZS05ZWM5NDMyOTE3Y2EiLCJlbWFpbCI6ImFudEBzdXBhYmFzZS5pbyIsImFwcF9tZXRhZGF0YSI6eyJwcm92aWRlciI6ImVtYWlsIn0sInVzZXJfbWV0YWRhdGEiOnt9LCJyb2xlIjoiYXV0aGVudGljYXRlZCJ9<span class=\"token punctuation\">.</span>4IFzn4eymqUNYYo2AHLxNRL8m08G93Qcg3_fblGqDjo\n\n<span class=\"token comment\">// 默认情况下，60分钟内有效</span>\n<span class=\"token operator\">&amp;</span>expires_in<span class=\"token operator\">=</span><span class=\"token number\">3600</span>\n\n<span class=\"token comment\">// 用来在60分钟到期前获得新的访问令牌</span>\n<span class=\"token operator\">&amp;</span>refresh_token<span class=\"token operator\">=</span>RuioJv2eLV05lgH5AlJwTw\n\n<span class=\"token comment\">// 可以作为授权:在对你的API的请求中使用Bearer header</span>\n<span class=\"token operator\">&amp;</span>token_type<span class=\"token operator\">=</span>bearer\n\n<span class=\"token comment\">// 这是一个注册、登录、密码重置或magic link?</span>\n<span class=\"token operator\">&amp;</span>type<span class=\"token operator\">=</span>signup</code></pre><div class=\"toolbar\"><div class=\"toolbar-item\"><button aria-label=\"copy\" class=\"copy-to-clipboard-button\" data-copy-state=\"copy\" type=\"button\"><span></span></button></div></div></div>\n</div>\n<p>如果我们把access_token放入<a href=\"https://jwt.io\" rel=\"external\" target=\"_blank\">https://jwt.io<svg height=\"16\" viewbox=\"0 0 24 24\" width=\"16\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\"M14 5c-.552 0-1-.448-1-1s.448-1 1-1h6c.552 0 1 .448 1 1v6c0 .552-.448 1-1 1s-1-.448-1-1v-3.586l-7.293 7.293c-.391.39-1.024.39-1.414 0-.391-.391-.391-1.024 0-1.414l7.293-7.293h-3.586zm-9 2c-.552 0-1 .448-1 1v11c0 .552.448 1 1 1h11c.552 0 1-.448 1-1v-4.563c0-.552.448-1 1-1s1 .448 1 1v4.563c0 1.657-1.343 3-3 3h-11c-1.657 0-3-1.343-3-3v-11c0-1.657 1.343-3 3-3h4.563c.552 0 1 .448 1 1s-.448 1-1 1h-4.563z\" fill=\"currentColor\"></path></svg></a>，我们会看到它被解码为:</p>\n<div class=\"prism-codeblock\">\n<div class=\"code-toolbar\"><pre class=\"language-jsx\" id=\"1e516d0\" tabindex=\"0\"><code class=\"language-jsx\"><span class=\"token punctuation\">{</span>\n  <span class=\"token string-property property\">\"aud\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"authenticated\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"exp\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1616429064</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"sub\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"5a4365e7-7c7d-4eaf-a8ee-9ec9432917ca\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"email\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ant@supabase.io\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"app_metadata\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string-property property\">\"provider\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"email\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"user_metadata\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"role\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"authenticated\"</span>\n<span class=\"token punctuation\">}</span></code></pre><div class=\"toolbar\"><div class=\"toolbar-item\"><button aria-label=\"copy\" class=\"copy-to-clipboard-button\" data-copy-state=\"copy\" type=\"button\"><span></span></button></div></div></div>\n</div>\n<p><code>authenticated</code>角色在Supabase中很特别，它告诉API这是一个已认证的用户，并知道将JWT与你添加到请求的资源（表或行）的任何策略进行比较。</p>\n<p><code>sub</code>声称通常是我们用来将JWT与你数据库中的行相匹配的，因为默认情况下它是<code>auth.users</code>表中用户的唯一标识符（作为附带说明–一般不建议以任何方式改变你Supabase数据库中的<code>auth</code>模式，因为Auth API依靠它来正常运行）。</p>\n<p>对于好奇心强的人来说，可以尝试进入SQL编辑器并进行查询：</p>\n<div class=\"prism-codeblock\">\n<div class=\"code-toolbar\"><pre class=\"language-sql\" id=\"fb3ff51\" tabindex=\"0\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> auth<span class=\"token punctuation\">.</span>users<span class=\"token punctuation\">;</span></code></pre><div class=\"toolbar\"><div class=\"toolbar-item\"><button aria-label=\"copy\" class=\"copy-to-clipboard-button\" data-copy-state=\"copy\" type=\"button\"><span></span></button></div></div></div>\n</div>\n<p>如果supabase-js在你的网站上被加载（这里是http://localhost:3000），它会自动从URL中提取<code>access_token</code>并启动一个会话。你可以检索<a href=\"/docs/app/sdkdocs/javascript/auth-getsession\">session</a>以查看是否有一个有效的会话。</p>\n<div class=\"prism-codeblock\">\n<div class=\"code-toolbar\"><pre class=\"language-jsx\" id=\"771edac\" tabindex=\"0\"><code class=\"language-jsx\">console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>supabase<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">.</span><span class=\"token function\">getSession</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre><div class=\"toolbar\"><div class=\"toolbar-item\"><button aria-label=\"copy\" class=\"copy-to-clipboard-button\" data-copy-state=\"copy\" type=\"button\"><span></span></button></div></div></div>\n</div>\n<p>现在我们可以使用方法向用户发布JWTs，我们想开始获取特定于该用户的资源。因此，让我们做一些。转到SQL编辑器，运行。</p>\n<div class=\"prism-codeblock\">\n<div class=\"code-toolbar\"><pre class=\"language-sql\" id=\"2c97528\" tabindex=\"0\"><code class=\"language-sql\"><span class=\"token keyword\">create</span> <span class=\"token keyword\">table</span> my_scores <span class=\"token punctuation\">(</span>\n    name <span class=\"token keyword\">text</span><span class=\"token punctuation\">,</span>\n    score <span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span>\n    user_id uuid <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">TABLE</span> my_scores <span class=\"token keyword\">ENABLE</span> <span class=\"token keyword\">ROW</span> <span class=\"token keyword\">LEVEL</span> SECURITY<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> my_scores<span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> score<span class=\"token punctuation\">,</span> user_id<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">values</span>\n  <span class=\"token punctuation\">(</span><span class=\"token string\">'Paul'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">100</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'5a4365e7-7c7d-4eaf-a8ee-9ec9432917ca'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">(</span><span class=\"token string\">'Paul'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'5a4365e7-7c7d-4eaf-a8ee-9ec9432917ca'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">(</span><span class=\"token string\">'Leto'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">50</span><span class=\"token punctuation\">,</span>  <span class=\"token string\">'9ec94326-2e2d-2ea2-22e3-3a535a4365e7'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">-- use UUIDs from the auth.users table if you want to try it</span>\n<span class=\"token comment\">-- for yourself</span></code></pre><div class=\"toolbar\"><div class=\"toolbar-item\"><button aria-label=\"copy\" class=\"copy-to-clipboard-button\" data-copy-state=\"copy\" type=\"button\"><span></span></button></div></div></div>\n</div>\n<p>现在我们要写我们的策略，还是用SQL，但注意也可以通过仪表盘上的Auth &gt; Policies来添加。</p>\n<div class=\"prism-codeblock\">\n<div class=\"code-toolbar\"><pre class=\"language-sql\" id=\"802aada\" tabindex=\"0\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> POLICY user_update_own_scores <span class=\"token keyword\">ON</span> my_scores\n  <span class=\"token keyword\">FOR</span> <span class=\"token keyword\">ALL</span>\n  <span class=\"token keyword\">USING</span> <span class=\"token punctuation\">(</span>auth<span class=\"token punctuation\">.</span>uid<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> user_id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre><div class=\"toolbar\"><div class=\"toolbar-item\"><button aria-label=\"copy\" class=\"copy-to-clipboard-button\" data-copy-state=\"copy\" type=\"button\"><span></span></button></div></div></div>\n</div>\n<p>现在，假设你在你的javascript/supabase-js环境中有一个活动的会话，你可以做。</p>\n<div class=\"prism-codeblock\">\n<div class=\"code-toolbar\"><pre class=\"language-jsx\" id=\"8ba4d72\" tabindex=\"0\"><code class=\"language-jsx\">supabase<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">'my_scores'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span><span class=\"token string\">'*'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>console<span class=\"token punctuation\">.</span>log<span class=\"token punctuation\">)</span></code></pre><div class=\"toolbar\"><div class=\"toolbar-item\"><button aria-label=\"copy\" class=\"copy-to-clipboard-button\" data-copy-state=\"copy\" type=\"button\"><span></span></button></div></div></div>\n</div>\n<p>而你应该只收到属于当前登录用户的分数。另外，你也可以使用Bash，比如。</p>\n<div class=\"prism-codeblock\">\n<div class=\"code-toolbar\"><pre class=\"language-bash\" id=\"e30953f\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"token function\">curl</span> <span class=\"token string\">'https://sjvwsaokcugktsdaxxze.supabase.co/rest/v1/my_scores?select=*'</span> <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"apikey: &lt;ANON_KEY&gt;\"</span> <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Authorization: Bearer &lt;ACCESS_TOKEN&gt;\"</span></code></pre><div class=\"toolbar\"><div class=\"toolbar-item\"><button aria-label=\"copy\" class=\"copy-to-clipboard-button\" data-copy-state=\"copy\" type=\"button\"><span></span></button></div></div></div>\n</div>\n<p>请注意，要通过API网关，总是需要<code>anon key</code>（或<code>service role key</code>）。这可以在 <code>apikey</code>头或名为 <code>apikey</code>的查询参数中传递。只要你用它来实例化客户端，它就会在supabase-js中自动传递。</p>\n<p>这里还有一些关于如何构建你的模式以最好地与<code>auth.users</code>表整合的说明。</p>\n<p>一旦你掌握了策略的窍门，你就可以开始变得有点花哨了。比方说，我在暴雪工作，我只希望暴雪的工作人员能够更新人们的高分，我可以写一些东西:</p>\n<div class=\"prism-codeblock\">\n<div class=\"code-toolbar\"><pre class=\"language-sql\" id=\"38f72d8\" tabindex=\"0\"><code class=\"language-sql\"><span class=\"token keyword\">create</span> policy <span class=\"token string\">\"Only Blizzard staff can update leaderboard\"</span>\n<span class=\"token keyword\">on</span> my_scores\n<span class=\"token keyword\">for</span> <span class=\"token keyword\">update</span> <span class=\"token keyword\">using</span> <span class=\"token punctuation\">(</span>\n  <span class=\"token keyword\">right</span><span class=\"token punctuation\">(</span>auth<span class=\"token punctuation\">.</span>jwt<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">&gt;&gt;</span> <span class=\"token string\">'email'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">13</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token string\">'@blizzard.com'</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre><div class=\"toolbar\"><div class=\"toolbar-item\"><button aria-label=\"copy\" class=\"copy-to-clipboard-button\" data-copy-state=\"copy\" type=\"button\"><span></span></button></div></div></div>\n</div>\n<p>Supabase有两个内置的辅助函数。<code>auth.uid()</code>和<code>auth.jwt()</code>。</p>\n<p>在这里可以看到完整的PostgreSQL策略文档。<a href=\"https://www.postgresql.org/docs/12/sql-createpolicy.html\" rel=\"external\" target=\"_blank\">https://www.postgresql.org/docs/12/sql-createpolicy.html<svg height=\"16\" viewbox=\"0 0 24 24\" width=\"16\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\"M14 5c-.552 0-1-.448-1-1s.448-1 1-1h6c.552 0 1 .448 1 1v6c0 .552-.448 1-1 1s-1-.448-1-1v-3.586l-7.293 7.293c-.391.39-1.024.39-1.414 0-.391-.391-.391-1.024 0-1.414l7.293-7.293h-3.586zm-9 2c-.552 0-1 .448-1 1v11c0 .552.448 1 1 1h11c.552 0 1-.448 1-1v-4.563c0-.552.448-1 1-1s1 .448 1 1v4.563c0 1.657-1.343 3-3 3h-11c-1.657 0-3-1.343-3-3v-11c0-1.657 1.343-3 3-3h4.563c.552 0 1 .448 1 1s-.448 1-1 1h-4.563z\" fill=\"currentColor\"></path></svg></a></p>\n<p>你可以随心所欲地使用这些策略：</p>\n<h3 id=\"资源\">资源 <a aria-hidden=\"true\" class=\"anchor\" href=\"#%e8%b5%84%e6%ba%90\"><i class=\"material-icons align-middle\">link</i></a></h3><ul>\n<li>JWT debugger: <a href=\"https://jwt.io\" rel=\"external\" target=\"_blank\">https://jwt.io<svg height=\"16\" viewbox=\"0 0 24 24\" width=\"16\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\"M14 5c-.552 0-1-.448-1-1s.448-1 1-1h6c.552 0 1 .448 1 1v6c0 .552-.448 1-1 1s-1-.448-1-1v-3.586l-7.293 7.293c-.391.39-1.024.39-1.414 0-.391-.391-.391-1.024 0-1.414l7.293-7.293h-3.586zm-9 2c-.552 0-1 .448-1 1v11c0 .552.448 1 1 1h11c.552 0 1-.448 1-1v-4.563c0-.552.448-1 1-1s1 .448 1 1v4.563c0 1.657-1.343 3-3 3h-11c-1.657 0-3-1.343-3-3v-11c0-1.657 1.343-3 3-3h4.563c.552 0 1 .448 1 1s-.448 1-1 1h-4.563z\" fill=\"currentColor\"></path></svg></a>​</li>\n<li>PostgeSQL政策: <a href=\"https://www.postgresql.org/docs/12/sql-createpolicy.html\" rel=\"external\" target=\"_blank\">https://www.postgresql.org/docs/12/sql-createpolicy.html<svg height=\"16\" viewbox=\"0 0 24 24\" width=\"16\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\"M14 5c-.552 0-1-.448-1-1s.448-1 1-1h6c.552 0 1 .448 1 1v6c0 .552-.448 1-1 1s-1-.448-1-1v-3.586l-7.293 7.293c-.391.39-1.024.39-1.414 0-.391-.391-.391-1.024 0-1.414l7.293-7.293h-3.586zm-9 2c-.552 0-1 .448-1 1v11c0 .552.448 1 1 1h11c.552 0 1-.448 1-1v-4.563c0-.552.448-1 1-1s1 .448 1 1v4.563c0 1.657-1.343 3-3 3h-11c-1.657 0-3-1.343-3-3v-11c0-1.657 1.343-3 3-3h4.563c.552 0 1 .448 1 1s-.448 1-1 1h-4.563z\" fill=\"currentColor\"></path></svg></a></li>\n<li>PostgREST行级安全: <a href=\"https://postgrest.org/en/v7.0.0/auth.html\" rel=\"external\" target=\"_blank\">https://postgrest.org/en/v7.0.0/auth.html<svg height=\"16\" viewbox=\"0 0 24 24\" width=\"16\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\"M14 5c-.552 0-1-.448-1-1s.448-1 1-1h6c.552 0 1 .448 1 1v6c0 .552-.448 1-1 1s-1-.448-1-1v-3.586l-7.293 7.293c-.391.39-1.024.39-1.414 0-.391-.391-.391-1.024 0-1.414l7.293-7.293h-3.586zm-9 2c-.552 0-1 .448-1 1v11c0 .552.448 1 1 1h11c.552 0 1-.448 1-1v-4.563c0-.552.448-1 1-1s1 .448 1 1v4.563c0 1.657-1.343 3-3 3h-11c-1.657 0-3-1.343-3-3v-11c0-1.657 1.343-3 3-3h4.563c.552 0 1 .448 1 1s-.448 1-1 1h-4.563z\" fill=\"currentColor\"></path></svg></a></li>\n</ul>\n<h3 id=\"下一步\">下一步 <a aria-hidden=\"true\" class=\"anchor\" href=\"#%e4%b8%8b%e4%b8%80%e6%ad%a5\"><i class=\"material-icons align-middle\">link</i></a></h3><ul>\n<li>\n<p>观看<a data-bs-delay='{\"hide\":300,\"show\":550}' data-bs-html=\"true\" data-bs-title=\"&lt;a href='/docs/app/development_guide/auth/auth-deep-dive/auth-deep-dive-jwts/'&gt;&lt;p&gt;深层探索&lt;/p&gt;&lt;strong&gt;第一部分:JWTS&lt;/strong&gt;&lt;br&gt;&lt;/a&gt;\" data-bs-toggle=\"tooltip\" href=\"/docs/app/development_guide/auth/auth-deep-dive/auth-deep-dive-jwts/\">第一部分：JWTs</a></p>\n</li>\n<li>\n<p><a data-bs-delay='{\"hide\":300,\"show\":550}' data-bs-html=\"true\" data-bs-title=\"&lt;a href='/docs/app/development_guide/auth/auth-deep-dive/auth-row-level-security/'&gt;&lt;p&gt;深层探索&lt;/p&gt;&lt;strong&gt;第二部分:行级安全&lt;/strong&gt;&lt;br&gt;Supabase Auth Deep Dive第二部分 - 行级安全&lt;/a&gt;\" data-bs-toggle=\"tooltip\" href=\"/docs/app/development_guide/auth/auth-deep-dive/auth-row-level-security/\">第二部分:行级安全</a></p>\n</li>\n</ul>\n<!-- - [第三部分:政策](../../learn/auth-deep-dive/auth-policies)-->\n<ul>\n<li><a data-bs-delay='{\"hide\":300,\"show\":550}' data-bs-html=\"true\" data-bs-title=\"&lt;a href='/docs/app/development_guide/auth/auth-deep-dive/auth-gotrue/'&gt;&lt;p&gt;深层探索&lt;/p&gt;&lt;strong&gt;第四部分: GoTrue&lt;/strong&gt;&lt;br&gt;Supabase深潜第四部分：Gotrue概述&lt;/a&gt;\" data-bs-toggle=\"tooltip\" href=\"/docs/app/development_guide/auth/auth-deep-dive/auth-gotrue/\">第四部分: GoTrue</a></li>\n<li>注册加入<a href=\"https://cloud.memfiredb.com/\" rel=\"external\" target=\"_blank\">MemFire Cloud<svg height=\"16\" viewbox=\"0 0 24 24\" width=\"16\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\"M14 5c-.552 0-1-.448-1-1s.448-1 1-1h6c.552 0 1 .448 1 1v6c0 .552-.448 1-1 1s-1-.448-1-1v-3.586l-7.293 7.293c-.391.39-1.024.39-1.414 0-.391-.391-.391-1.024 0-1.414l7.293-7.293h-3.586zm-9 2c-.552 0-1 .448-1 1v11c0 .552.448 1 1 1h11c.552 0 1-.448 1-1v-4.563c0-.552.448-1 1-1s1 .448 1 1v4.563c0 1.657-1.343 3-3 3h-11c-1.657 0-3-1.343-3-3v-11c0-1.657 1.343-3 3-3h4.563c.552 0 1 .448 1 1s-.448 1-1 1h-4.563z\" fill=\"currentColor\"></path></svg></a></li>\n</ul>\n</div>\n</div>\n<div><hr class=\"doc-hr\"/>\n<div class=\"d-print-none\" id=\"doc-nav\">\n<div class=\"row flex-xl-nowrap\">\n<div class=\"col-sm-6 pt-2 doc-next\">\n<a href=\"/docs/app/development_guide/auth/auth-deep-dive/auth-row-level-security/\">\n<div class=\"card h-100 my-1\">\n<div class=\"card-body py-2\">\n<p class=\"card-title fs-5 fw-semibold lh-base mb-0\"><i class=\"material-icons align-middle\">navigate_before</i> 第二部分:行级安全</p>\n</div>\n</div>\n</a>\n</div>\n<div class=\"col-sm-6 pt-2 doc-prev\">\n<a class=\"ms-auto\" href=\"/docs/app/development_guide/auth/auth-deep-dive/auth-gotrue/\">\n<div class=\"card h-100 my-1 text-end\">\n<div class=\"card-body py-2\">\n<p class=\"card-title fs-5 fw-semibold lh-base mb-0\">第四部分: GoTrue <i class=\"material-icons align-middle\">navigate_next</i></p>\n</div>\n</div>\n</a>\n</div>\n</div>\n</div></div>\n</div>\n</div>\n</div>\n</div>\n\n</main>",
  "markdown": "[MemFireDB备份 6](/)\n\nmenu\n\n[官网](https://memfiredb.com/)\n[论坛](https://community.memfiredb.com/)\n[登录](https://cloud.memfiredb.com/auth/login)\n\nEnable dark mode\n\nEnable light mode\n\n本页\n\n关于\n\n# 第三部分:策略\n\n### 关于 [*link*](#%e5%85%b3%e4%ba%8e)\n\n如何将表的访问限制在认证用户、行级策略和基于电子邮件域的访问。\n\n### 观察 [*link*](#%e8%a7%82%e5%af%9f)\n\n### 基于用户的行级策略 [*link*](#%e5%9f%ba%e4%ba%8e%e7%94%a8%e6%88%b7%e7%9a%84%e8%a1%8c%e7%ba%a7%e7%ad%96%e7%95%a5)\n\n现在我们知道了如何根据JWT角色来限制对表的访问，我们可以把它和用户管理结合起来，让我们更多地控制你的用户可以从你的数据库中读取和写入哪些数据。\n\n我们将从用户会话在Supabase中的工作方式开始，然后转到编写以用户为中心的策略。\n\n比方说，我们要把一个用户第一次注册到我们的服务中。典型的方法是在supabase-js中调用以下方法：\n\n```\n// see full api reference here: /docs/app/sdkdocs/javascript/auth-signup\nsupabase.auth.signUp({ email, password })\n```\n\n默认情况下，这将向用户发送一封确认电子邮件。当用户点击电子邮件中的链接时，他们将被重定向到你的网站（你需要在仪表板上的授权>设置中提供你的网站网址。默认情况下，这是http://localhost:3000），包括查询参数的完整URL将看起来像这样:\n\n```\nhttp://localhost:3000/#access_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJhdXRoZW50aWNhdGVkIiwiZXhwIjoxNjE2NDI5MDY0LCJzdWIiOiI1YTQzNjVlNy03YzdkLTRlYWYtYThlZS05ZWM5NDMyOTE3Y2EiLCJlbWFpbCI6ImFudEBzdXBhYmFzZS5pbyIsImFwcF9tZXRhZGF0YSI6eyJwcm92aWRlciI6ImVtYWlsIn0sInVzZXJfbWV0YWRhdGEiOnt9LCJyb2xlIjoiYXV0aGVudGljYXRlZCJ9.4IFzn4eymqUNYYo2AHLxNRL8m08G93Qcg3_fblGqDjo&expires_in=3600&refresh_token=RuioJv2eLV05lgH5AlJwTw&token_type=bearer&type=signup\n```\n\n让我们把这个问题拆开，以便更容易阅读。\n\n```\n// 基本网址 - 你在app.supabase.com仪表板的授权设置中设置的任何网址\nhttp://localhost:3000/\n\n// 注意我们使用'#'（片段）而不是'?'查询参数\n// 访问令牌是发给用户的JWT。\n#access_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJhdXRoZW50aWNhdGVkIiwiZXhwIjoxNjE2NDI5MDY0LCJzdWIiOiI1YTQzNjVlNy03YzdkLTRlYWYtYThlZS05ZWM5NDMyOTE3Y2EiLCJlbWFpbCI6ImFudEBzdXBhYmFzZS5pbyIsImFwcF9tZXRhZGF0YSI6eyJwcm92aWRlciI6ImVtYWlsIn0sInVzZXJfbWV0YWRhdGEiOnt9LCJyb2xlIjoiYXV0aGVudGljYXRlZCJ9.4IFzn4eymqUNYYo2AHLxNRL8m08G93Qcg3_fblGqDjo\n\n// 默认情况下，60分钟内有效\n&expires_in=3600\n\n// 用来在60分钟到期前获得新的访问令牌\n&refresh_token=RuioJv2eLV05lgH5AlJwTw\n\n// 可以作为授权:在对你的API的请求中使用Bearer header\n&token_type=bearer\n\n// 这是一个注册、登录、密码重置或magic link?\n&type=signup\n```\n\n如果我们把access\\_token放入<https://jwt.io>，我们会看到它被解码为:\n\n```\n{\n  \"aud\": \"authenticated\",\n  \"exp\": 1616429064,\n  \"sub\": \"5a4365e7-7c7d-4eaf-a8ee-9ec9432917ca\",\n  \"email\": \"ant@supabase.io\",\n  \"app_metadata\": {\n    \"provider\": \"email\"\n  },\n  \"user_metadata\": {},\n  \"role\": \"authenticated\"\n}\n```\n\n`authenticated`角色在Supabase中很特别，它告诉API这是一个已认证的用户，并知道将JWT与你添加到请求的资源（表或行）的任何策略进行比较。\n\n`sub`声称通常是我们用来将JWT与你数据库中的行相匹配的，因为默认情况下它是`auth.users`表中用户的唯一标识符（作为附带说明–一般不建议以任何方式改变你Supabase数据库中的`auth`模式，因为Auth API依靠它来正常运行）。\n\n对于好奇心强的人来说，可以尝试进入SQL编辑器并进行查询：\n\n```\nselect * from auth.users;\n```\n\n如果supabase-js在你的网站上被加载（这里是http://localhost:3000），它会自动从URL中提取`access_token`并启动一个会话。你可以检索[session](/docs/app/sdkdocs/javascript/auth-getsession)以查看是否有一个有效的会话。\n\n```\nconsole.log(supabase.auth.getSession())\n```\n\n现在我们可以使用方法向用户发布JWTs，我们想开始获取特定于该用户的资源。因此，让我们做一些。转到SQL编辑器，运行。\n\n```\ncreate table my_scores (\n    name text,\n    score int,\n    user_id uuid not null\n);\n\nALTER TABLE my_scores ENABLE ROW LEVEL SECURITY;\n\ninsert into my_scores(name, score, user_id)\nvalues\n  ('Paul', 100, '5a4365e7-7c7d-4eaf-a8ee-9ec9432917ca'),\n  ('Paul', 200, '5a4365e7-7c7d-4eaf-a8ee-9ec9432917ca'),\n  ('Leto', 50,  '9ec94326-2e2d-2ea2-22e3-3a535a4365e7');\n\n-- use UUIDs from the auth.users table if you want to try it\n-- for yourself\n```\n\n现在我们要写我们的策略，还是用SQL，但注意也可以通过仪表盘上的Auth > Policies来添加。\n\n```\nCREATE POLICY user_update_own_scores ON my_scores\n  FOR ALL\n  USING (auth.uid() = user_id);\n```\n\n现在，假设你在你的javascript/supabase-js环境中有一个活动的会话，你可以做。\n\n```\nsupabase.from('my_scores').select('*').then(console.log)\n```\n\n而你应该只收到属于当前登录用户的分数。另外，你也可以使用Bash，比如。\n\n```\ncurl 'https://sjvwsaokcugktsdaxxze.supabase.co/rest/v1/my_scores?select=*' \\\n-H \"apikey: <ANON_KEY>\" \\\n-H \"Authorization: Bearer <ACCESS_TOKEN>\"\n```\n\n请注意，要通过API网关，总是需要`anon key`（或`service role key`）。这可以在 `apikey`头或名为 `apikey`的查询参数中传递。只要你用它来实例化客户端，它就会在supabase-js中自动传递。\n\n这里还有一些关于如何构建你的模式以最好地与`auth.users`表整合的说明。\n\n一旦你掌握了策略的窍门，你就可以开始变得有点花哨了。比方说，我在暴雪工作，我只希望暴雪的工作人员能够更新人们的高分，我可以写一些东西:\n\n```\ncreate policy \"Only Blizzard staff can update leaderboard\"\non my_scores\nfor update using (\n  right(auth.jwt() ->> 'email', 13) = '@blizzard.com'\n);\n```\n\nSupabase有两个内置的辅助函数。`auth.uid()`和`auth.jwt()`。\n\n在这里可以看到完整的PostgreSQL策略文档。<https://www.postgresql.org/docs/12/sql-createpolicy.html>\n\n你可以随心所欲地使用这些策略：\n\n### 资源 [*link*](#%e8%b5%84%e6%ba%90)\n\n* JWT debugger: <https://jwt.io>​\n* PostgeSQL政策: <https://www.postgresql.org/docs/12/sql-createpolicy.html>\n* PostgREST行级安全: <https://postgrest.org/en/v7.0.0/auth.html>\n\n### 下一步 [*link*](#%e4%b8%8b%e4%b8%80%e6%ad%a5)\n\n* 观看[第一部分：JWTs](/docs/app/development_guide/auth/auth-deep-dive/auth-deep-dive-jwts/)\n* [第二部分:行级安全](/docs/app/development_guide/auth/auth-deep-dive/auth-row-level-security/)\n\n* [第四部分: GoTrue](/docs/app/development_guide/auth/auth-deep-dive/auth-gotrue/)\n* 注册加入[MemFire Cloud](https://cloud.memfiredb.com/)\n\n---\n\n[*navigate\\_before* 第二部分:行级安全](/docs/app/development_guide/auth/auth-deep-dive/auth-row-level-security/)\n\n[第四部分: GoTrue *navigate\\_next*](/docs/app/development_guide/auth/auth-deep-dive/auth-gotrue/)"
}